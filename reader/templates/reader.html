{% load static %}
<html>
<head>
    <!--<link rel="stylesheet" type="text/css" href="{% static "annotorious-0.6.4/css/annotorious.css" %}" />-->
    <link rel="stylesheet" type="text/css" href="{% static "annotator/css/annotator.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "annotator/css/annotator.min.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "reader/css/reader.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "reader/css/modal.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "annotator/view_annotator/css/style.css" %}" />


    <link href="https://fonts.googleapis.com/css?family=Droid+Serif" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <!--<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>-->

    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
    <script src="{% static "reader/js/jquery-1.9.1.js" %}"></script>
    <script src="{% static "annotator/js/annotator-full.min.js" %}"></script>

    <script type="text/javascript" src="{% static "annotator/view_annotator/js/jquery.dateFormat.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/i18n/jquery.i18n.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/i18n/locale/en/annotator.js" %}"></script>

    <script type="text/javascript" src="{% static "annotator/view_annotator/js/view_annotator.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/tinymce/tinymce.min.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/js/richEditor.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/view_annotator/js/jquery.slimscroll.js" %}"></script>
    <script type="text/javascript" src="{% static "annotator/js/short-unique-id.min.js" %}"></script>


    <!--<script type="text/javascript" src="{% static "annotorious-0.6.4/annotorious.min.js" %}"></script>-->
    <script type="text/javascript" src="{% static "reader/js/within-viewport/withinviewport.js" %}"></script>

    <!--<script src="https://hypothes.is/embed.js" async></script>-->



    <!-- Latest compiled and minified CSS -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
    <!-- Optional theme -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">-->
    <!-- Latest compiled and minified JavaScript -->
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>-->

    <script src="//d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="{% static "reader/js/cloud.js" %}"></script>
    <!--<script type="text/javascript" src="{% static "reader/js/fisheye.js" %}"></script>-->

</head>
<body>
<div id="left-div">
    <div id="vis-div">
    </div>
    <div id="toc-div">
    </div>
</div>
<div id="reader-div">
   <div id="reader-controls">
        <button class="previous-btn">❮ Previous</button>
        <span class="title-current-section"></span>
        <button class="next-btn">Next ❯</button>
        <button class="quiz-btn" disabled>Go to quiz ✎</button>

    </div>
    <div id="reader-canvas">
    </div>
</div>
<!--<div id="support-div">
    <div id="recommendations-div"></div>
    <div id="concepts-div"></div>
</div>-->

<!-- The Modal -->
<div id="myModal" class="modal">
  <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2 class="quiz-title">Quiz time!</h2>
      </div>
      <div class="modal-body">
          <p class="quiz-instructions"> Please ask the facilitator for the quiz corresponding to the section(s) that you just have finished reading.
              </br>
              </br>
              </br>Once you fill it completely, please return it to the facilitator and then, press the "Submit" button</p>
      </div>
      <div class="modal-footer">
        <button class="submit-btn">Submit</button>
      </div>
    </div>
</div>

<script type="text/javascript">

    var uid = new ShortUniqueId();

    var last_page_read = {};
    var resource_id;
    var course_hierarchical_structure = {};
    var course_linear_structure = [];
    var quiz_data= {};
    var modal;

    var progressVisUpdater;

    //var section_quizzes = {"ir-4-1-1-1":false,"ir-4-1-1-3":false,"ir-4-1-2-3":false,"ir-4-1-4":false};

    var toc_color = d3.scale.linear()
        .domain([1,5])
        .range(["#F99B39","#FAD594"]);

    var color = d3.scale.linear()
        .domain([0.0, 1.0])
        //.range(["#ECEEF5", "#011568"]);
        .range(["#E0E0E0", "#339933"]);


    jQuery(function ($) {
        $.i18n.load(i18n_dict);

        var t = '';

        var csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        loadHtml();

        $('.previous-btn').click( function(e) {
            e.preventDefault();
            loadPreviousPage();
            return false;
        });

        $('.next-btn').click( function(e) {
            e.preventDefault();
            loadNextPage();
            return false;
        });

        $('.quiz-btn').click( function(e) {
            e.preventDefault();
            openQuizWindow();
            return false;
        });

        $('.submit-btn').click( function(e) {
            e.preventDefault();
            submitQuiz();
            return false;
        });

        // Get the modal
        modal = document.getElementById('myModal');

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            closeQuizWindow();
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                closeQuizWindow();
            }
        }

        function gText(e) {
            t = window.getSelection().toString();
            console.log(t);
            $.ajax({
                    url: 'http://en.wikipedia.org/w/api.php',
                    data: { action: 'query', list: 'search', srsearch: t, format: 'json' },
                    dataType: 'jsonp',
                    success: processResult
                });
        }

        function processResult(apiResult){
         for (var i = 0; i < apiResult.query.search.length; i++){
              $('#recommendations-div').append('<p>'+apiResult.query.search[i].title+'</p>');
         }
      }

        //document.onmouseup = gText;
    });

// extension:
/*$.fn.scrollEnd = function(callback, timeout) {
  $(this).scroll(function(){
    var $this = $(this);
    if ($this.data('scrollTimeout')) {
      clearTimeout($this.data('scrollTimeout'));
    }
    $this.data('scrollTimeout', setTimeout(callback,timeout));
  });
};

$(window).bind('scrollStart', function(){
    scrolling = true;
    console.log('scrollStart');
});

$(window).bind('scrollEnd', function(){
    scrolling = false;
    console.log('scrollEnd');
});*/


function loadHtml() {
    {% autoescape off %}
    course_hierarchical_structure = {{course_hierarchical}};
    last_page_read = {{last_page_read}};
    {% endautoescape %}
    hierarchicalToLinearStructure(course_hierarchical_structure);
    //If the user has not read any page from the course, the first page needs to be shown

    if(jQuery.isEmptyObject(last_page_read)){
        last_page_read = course_linear_structure[0];
        last_page_read["page"]=last_page_read["spage"];
    }else{
        var last_section_read = $.grep(course_linear_structure, function(d){ return d.id == last_page_read["section"]; });
        var last_page_read_number = parseInt(last_page_read["page"]);
        last_page_read = last_section_read[0];
        last_page_read["page"] = last_page_read_number;
        console.log(last_page_read);
    }

    progressVisUpdater = initProgressVis(course_hierarchical_structure);

    initToc(course_hierarchical_structure);

    loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"]);

    var text_html = $('.t').text();
    console.log($(".t")[0]);
    //initWordCloud(text_html);


    //});

}


function initProgressVis(root){

    var w = $("#vis-div").width();
    var h = $("#vis-div").height();

    var svg_size = w;//Change for making svg and svg-comp diferent

    var partition = d3.layout.partition()
        .sort(null)
        .children(function children(d) {
          return d.children;
        })
        .value(function(d) {return Math.log(d.epage-d.spage+1); });


    var x = d3.scale.linear()
        .range([0, w]);
        //.range([0, h]);
    var y = d3.scale.linear()
            .range([0, h]);
            //range([0, w]);

    var x_comp = d3.scale.linear()
        .range([w, 0]);

    var separation = 1.5;
    var y_separation = 1;

    updateProgressVis(course_hierarchical_structure);
    function updateProgressVis(root) {

    /*var svg_comp = d3.select("#vis-div").append("svg")
        .attr("id","svg-vis-comp")
        .attr("width", svg_size )
        .attr("height", h)
            .append("g")
            .attr("id","g_progress_vis_comp");

    var rect_comp = svg_comp.selectAll("rect");

    rect_comp = rect_comp
          .data(partition(root))
        .enter().append("g")
            .attr("class", function (d) {
                    classname = "partition_depth_" + d.depth;

                    //if (d.depth > 0){
                        classname += " partition_docno_" + d.docno;
                    //}

                    return classname;
                })
            .append("rect")
          .attr("x", function(d) {
                return x_comp(d.y)-d.depth*separation;
                //return d.depth*(separation+widthLayer);
            })
          .attr("y", function(d) { return y(d.x)+y_separation; })
          .attr("width", function(d) { return x(d.dy); })
          .attr("height", function(d) { return y(d.dx); })
          .attr("fill", function (d) {
                    var visited_pages = d.group_read_pages;
                    var total_section_pages = d.num_pages;
                    var proportion_visited_pages = visited_pages/total_section_pages;
                    return color(proportion_visited_pages);
                })
          .attr("class", function (d) {
                    classname = "partition_depth_" + d.depth;

                    //if (d.depth > 0){
                        classname += " partition_docno_" + d.docno;
                    //}

                    return classname;
                })
          .attr("display", function(d) { return d.depth && d.depth<=4 ? null : "none"; })//d.depth && d.depth<=3 ? null : "none"; })
          .attr("stroke-width","1px")
          .attr("stroke","white")
          .attr("opacity",1)
          .on("mouseover",visSectionMouseover)
          .on("mouseout",visSectionMouseout);
          /*.on("click", visSectionClick)
          .on("dblclick", partitionTableDoubleClick)
          .on("mouseout",partitionTableMouseout);*/

        var svg_ind = d3.select("#vis-div").append("svg")
            .attr("id", "svg-vis")
            .attr("width", svg_size)
            .attr("height", h)
            .append("g")
            .attr("id", "g_progress_vis")
            .attr("transform", "translate(-10,0)");//TODO: parametrize horizontal translation

        var rect = svg_ind.selectAll("rect");

        rect = rect
            .data(partition(root), function (d) {
                return d.id;
            })
            .enter().append("g")
            .attr("class", function (d) {
                classname = "partition_depth_" + d.depth;

                return classname;
            })
            .append("rect")
            .attr("x", function (d) {
                return x(d.y) + d.depth * separation;
            })
            .attr("y", function (d) {
                return y(d.x) + y_separation;
            })
            .attr("width", function (d) {
                return x(d.dy);
            })
            .attr("height", function (d) {
                return y(d.dx);
            })
            .attr("fill", function (d) {
                var visited_pages = d.read_pages;
                var total_section_pages = d.num_pages;
                var proportion_visited_pages = visited_pages / total_section_pages;
                return color(proportion_visited_pages);
            })
            .attr("class", function (d) {
                classname = "partition_depth_" + d.depth;

                return classname;
            })
            .attr("id", function(d){return "rect-"+d.id;})
            .attr("display", function (d) {
                return d.depth && d.depth <= 4 ? null : "none";
            })//d.depth && d.depth<=3 ? null : "none"; })
            .attr("stroke-width", "1px")
            .attr("stroke", "white")
            .attr("opacity", 1)
            .on("click", visSectionClick)
            .on("mouseover", visSectionMouseover)
            .on("mouseout", visSectionMouseout);
        /*.on("dblclick", partitionTableDoubleClick)
          .on("mouseover",partitionTableMouseover)
          .on("mouseout",partitionTableMouseout);*/

        //Container for the gradients
        var defs = svg_ind.append("defs");

        //Filter for the outside glow
        var filter = defs.append("filter")
            .attr("id", "glow");
        filter.append("feGaussianBlur")
            .attr("stdDeviation", "4")
            .attr("result", "coloredBlur");
        var feMerge = filter.append("feMerge");
        feMerge.append("feMergeNode")
            .attr("in", "coloredBlur");
        feMerge.append("feMergeNode")
            .attr("in", "SourceGraphic");

        /*svg.on("mousemove", function() {
            fisheye.focus(d3.mouse(this));
            rect.each(function(d) { d.fisheye = fisheye(d); })
                .attr("x",function(d){return d.fisheye.y;});
        });*/

        /*var subsections = svg.selectAll("g.partition_depth_2");

        subsections.append("circle")
            .attr("cx", function (d,i) {*/
        /*if (i%2){
                    return x(d.y)+x(d.dy)+40;
                }else{
                    return x(d.y)+40;
                }*/
        //return (x(d.y)+x(d.dy)/2+(separation*2)-1.5);
        /*return (x(d.y)+x(d.dy)/2+(separation*2)-1.5);
            })
            .attr("cy", function (d,i) { return y(d.x)+(y(d.dx)/2); })
            .attr("r", 2)
            .style("fill", "#c5c5c5")*/
        //.attr("stroke-width","0.5px")
        //.style("stroke", "black")
        /*.style("z-index","1000");*/

        /*subsections.append("text")
                .attr("dx", function(d){return x(d.y)+x(d.dy)/2+(separation*2)-3.5;})
                .attr("dy", function (d) { return y(d.x)+(y(d.dx)/2)+3;})
                .style("font-size","8px")
                .text("?");*/

        /*var subsections3 = svg.selectAll("g.partition_depth_3");


        subsections3.append("circle")
            .attr("cx", function (d,i) {*/
        /*if (i%2){
                    return x(d.y)+x(d.dy)+40;
                }else{
                    return x(d.y)+40;
                }*/
        //return x(d.y)+x(d.dy)/2+(separation*4)-1.5;
        /*return (Math.random()*30)+(1.7*x(d.y))+(separation*4)-1.5;
            })
            .attr("cy", function (d,i) { return y(d.x)+(y(d.dx)/2); })
            .attr("r", 2)
            .style("fill", "#c5c5c5")*/
        //.attr("stroke-width","0.5px")
        //.style("stroke", "black")
        /*.style("z-index","1000");*/
    }

}

function loadResource(section_id,section_name,resource_id,page_num){
     var current_section = getSectionById(section_id);
     console.log(current_section);

     hierarchicalCourseSectionUpdate(course_hierarchical_structure.children,section_id,parseInt(page_num));


     var epage = parseInt(current_section["epage"]);
     var spage = parseInt(current_section["spage"]);
     console.log("epage: "+epage+" spage: "+spage+" page: "+page_num);

     //$("#toc-section-"+section_id).addClass("active");
    $(".previous-btn").prop("disabled",false);
    $(".next-btn").prop("disabled",false);
    $(".quiz-btn").prop("disabled",true);

    var last_section_read = $.grep(course_linear_structure, function(d){ return d.id == section_id; });
        last_section_read[0]["page"]=parseInt(page_num);
        last_page_read = last_section_read[0];

     if(page_num == spage){
        //$.get( "http://{{ request.META.HTTP_HOST }}/reader_project/api/kcs",
        /*$.get( "http://{{ request.META.HTTP_HOST }}/api/kcs",
                 {"user": {{ request.user.id }},
                 "group": "{{ group }}",
                 "sections": last_page_read["id"]},
                function(data){
                    console.log(data);
                });*/
        console.log("First page loaded");
        var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
        console.log(index_last_page_read);
        if (index_last_page_read==0){
            $(".previous-btn").prop("disabled",true);
        }
     }
     //var section_quizzes_ids = Object.keys(section_quizzes);
     if(page_num == epage){
         //Load quiz, if there is any quiz related to the section
        loadQuiz();
        //$(".next-btn").text("Go to quiz ✎");
        //$(".next-btn").removeClass("next-btn").addClass("quiz-btn");
        //$(".quiz-btn").unbind( "click" );
        //$(".quiz-btn").click(openQuizWindow);
        //$(".submit-btn").click(submitQuiz);
         // if(section_quizzes_ids.indexOf(section_id)>-1 && !section_quizzes[section_id]){
            $(".next-btn").prop("disabled",true);
            $(".quiz-btn").prop("disabled",false);
         //}
        var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
        if (index_last_page_read==course_linear_structure.length-1){
            $(".next-btn").prop("disabled",true);
        }

     }

     highlightTocSection(section_id);

     var resource_path = "resources/"+resource_id+"/"+resource_id+"-"+page_num+".html";

     $("#reader-canvas").load("{% static "/" %}"+resource_path,function() {

         //Set section title at the top of the reader
        $(".title-current-section").html(section_name);

        //initWordCloud(text_html);
        var annotator = $('#page-container').annotator().annotator().data('annotator');
        var propietary = {{ request.user.id }};
        annotator.addPlugin('Permissions', {
            user: propietary,
            permissions: {
                'read': [propietary],
                'update': [propietary],
                'delete': [propietary],
                'admin': [propietary]
         },
         showViewPermissionsCheckbox: true,
         showEditPermissionsCheckbox: false
        });
        $('#page-container').annotator().annotator('addPlugin', 'RichEditor');



        $('#page-container').annotator('addPlugin', 'Store', {
          // The endpoint of the store on your server.
          prefix: "/annotator",

          // Attach the uri of the current page to all annotations to allow search.
          annotationData: {
            "uuid": {{ request.user.id }}+"-"+uid.randomUUID(6),
            "uri": resource_id+"-"+page_num+".html",
            "user": {{ request.user.id }},
            "session": "{{ request.session.session_key }}",
            "group": "{{ group }}"
          },
          loadFromSearch: {
            //'limit': 20,
            "uri": resource_id+"-"+page_num+".html",
            "group": "{{ group }}"
          },
          urls: {
            // These are the default URLs.
            create:  '/annotations',
            update:  '/annotations/:id',
            destroy: '/annotations/:id',
            search:  '/search'
          }
         });


        $('#page-container').annotator().annotator('addPlugin', 'AnnotatorViewer');







        //var content = $('#page-container').annotator();
        /*content.annotator("addPlugin", "Store", {
          // The endpoint of the store on your server.
          prefix: "/annotator",

          // Attach the uri of the current page to all annotations to allow search.
          annotationData: {
            "uri": resource_id+"-"+page_num+".html",
            "user": {{ request.user.id }},
            "session": "{{ request.session.session_key }}",
            "group": "{{ group }}"
          },
          loadFromSearch: {
            //'limit': 20,
            "uri": resource_id+"-"+page_num+".html",
            "group": "{{ group }}"
          },
          urls: {
            // These are the default URLs.
            create:  '/annotations',
            update:  '/annotations/:id',
            destroy: '/annotations/:id',
            search:  '/search'
          }
         });

        var propietary = {{ request.user.id }};
        content.annotator("addPlugin","Permissions", {
                        user: propietary,
                        permissions: {
                            'read': [propietary],
                            'update': [propietary],
                            'delete': [propietary],
                            'admin': [propietary]
                     },
                     showViewPermissionsCheckbox: false,
                     showEditPermissionsCheckbox: false
                    });
        content.annotator("addPlugin", "RichEditor");
        content.annotator("addPlugin", "AnnotatorViewer");*/

         //Get all the text html containers
        var visible_text_elements = [];
        var visible_text = "";
        $("#page-container").find(".t").each(function(){
            if(isElementInViewport($(this))){
                visible_text_elements.push($(this).attr("class"));
                visible_text = visible_text + " " + $(this).text();
            }
        });
         console.log(new Date().toIsoString());

         var reader_height = document.getElementById("page-container").scrollHeight;
            console.log(reader_height);
            var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
		    var bottom = top + window.innerHeight;

		    top = Math.min(reader_height, Math.max(0, top));
		    bottom = Math.min(reader_height, Math.max(0, bottom));

		    // top and bottom are between 0 and 100
		    top = (100 * top / reader_height).toFixed(4);
		    bottom = (100 * bottom / reader_height).toFixed(4);

		    console.log("top: "+top+"bottom: "+bottom);
            var viewport_positions={"top":top,"bottom":bottom};

         //$.post( "http://{{ request.META.HTTP_HOST }}/reader_project/api/reader", JSON.stringify(
         $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-load",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": visible_text_elements,
             "extra": viewport_positions}));

         //If user scrolls the page
        var t, l = (new Date()).getTime(), scrolling = false;

        $("#page-container").scroll(function(){
            var now = (new Date()).getTime();

            if(now - l > 400 && !scrolling ){
                $(this).trigger('scrollStart');
                l = now;
            }

            clearTimeout(t);
            t = setTimeout(function(){
                if (scrolling)
                    $("#page-container").trigger('scrollEnd');
            }, 300);
        });

         $("#page-container").bind('scrollStart', function(){
            scrolling = true;
            console.log('scrollStart');
            //Log scroll event by using the reader api

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });

		    var reader_height = document.getElementById("page-container").scrollHeight;
            console.log(reader_height);
            var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
		    var bottom = top + window.innerHeight;

		    top = Math.min(reader_height, Math.max(0, top));
		    bottom = Math.min(reader_height, Math.max(0, bottom));

		    // top and bottom are between 0 and 100
		    top = (100 * top / reader_height).toFixed(2);
		    bottom = (100 * bottom / reader_height).toFixed(2);

		    console.log("top: "+top+"bottom: "+bottom);
            var viewport_positions={"top":top,"bottom":bottom};
            //$.post( "http://{{ request.META.HTTP_HOST }}/reader_project/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{request.session.session_key}}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-scroll-start",
             "datetime": new Date().toISOString(),
             "visible_text": visible_text_elements,
             "extra":viewport_positions}) );
        });

        $("#page-container").bind('scrollEnd', function(){
            scrolling = false;
            console.log('scrollEnd');
            //Log scroll event by using the reader api

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });

		    var reader_height = document.getElementById("page-container").scrollHeight;
            console.log(reader_height);
            var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
		    var bottom = top + window.innerHeight;

		    top = Math.min(reader_height, Math.max(0, top));
		    bottom = Math.min(reader_height, Math.max(0, bottom));

		    // top and bottom are between 0 and 100
		    top = (100 * top / reader_height).toFixed(4);
		    bottom = (100 * bottom / reader_height).toFixed(4);

		    console.log("top: "+top+"bottom: "+bottom);
            var viewport_positions={"top":top,"bottom":bottom};
            //$.post( "http://{{ request.META.HTTP_HOST }}/reader_project/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{request.session.session_key}}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-scroll-end",
             "datetime": new Date().toISOString(),
             "visible_text": visible_text_elements,
             "extra":viewport_positions}) );

        })
        /*$("#page-container").scrollEnd(function(){
            //Log scroll event by using the reader api

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });

		    var reader_height = document.getElementById("page-container").scrollHeight;
            console.log(reader_height);
            var top = $("#page-container").scrollTop() - $("#page-container").offset().top;
		    var bottom = top + window.innerHeight;

		    top = Math.min(reader_height, Math.max(0, top));
		    bottom = Math.min(reader_height, Math.max(0, bottom));

		    // top and bottom are between 0 and 100
		    top = (100 * top / reader_height).toFixed(4);
		    bottom = (100 * bottom / reader_height).toFixed(4);

		    console.log("top: "+top+"bottom: "+bottom);
            var viewport_positions={"top":top,"bottom":bottom};
            //$.post( "http://{{ request.META.HTTP_HOST }}/reader_project/api/reader", JSON.stringify(
            $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{request.session.session_key}}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-scroll",
             "datetime": new Date().toISOString(),
             "visible_text": visible_text_elements,
             "extra":viewport_positions}) );
        }, 100);*/
    });
}

function initWordCloud(text_string){
        var common = "poop,i,me,my,myself,we,us,our,ours,ourselves,you,your,yours,yourself,yourselves,he,him,his,himself,she,her,hers,herself,it,its,itself,they,them,their,theirs,themselves,what,which,who,whom,whose,this,that,these,those,am,is,are,was,were,be,been,being,have,has,had,having,do,does,did,doing,will,would,should,can,could,ought,i'm,you're,he's,she's,it's,we're,they're,i've,you've,we've,they've,i'd,you'd,he'd,she'd,we'd,they'd,i'll,you'll,he'll,she'll,we'll,they'll,isn't,aren't,wasn't,weren't,hasn't,haven't,hadn't,doesn't,don't,didn't,won't,wouldn't,shan't,shouldn't,can't,cannot,couldn't,mustn't,let's,that's,who's,what's,here's,there's,when's,where's,why's,how's,a,an,the,and,but,if,or,because,as,until,while,of,at,by,for,with,about,against,between,into,through,during,before,after,above,below,to,from,up,upon,down,in,out,on,off,over,under,again,further,then,once,here,there,when,where,why,how,all,any,both,each,few,more,most,other,some,such,no,nor,not,only,own,same,so,than,too,very,say,says,said,shall";

        var word_count = {};
        console.log("init wordcloud");
        var words = text_string.split(/[ '\-\(\)\*":;\[\]|{},.!?]+/);
          if (words.length == 1){
            word_count[words[0]] = 1;
          } else {
            words.forEach(function(word){
              var word = word.toLowerCase();
              if (word != "" && common.indexOf(word)==-1 && word.length>1){
                if (word_count[word]){
                  word_count[word]++;
                } else {
                  word_count[word] = 1;
                }
              }
            })
          }

        var svg_location = "#concepts-div";
        var width = document.getElementById("concepts-div").clientWidth;//$(document).width();
        var height = document.getElementById("concepts-div").clientHeight;//$(document).width();
        //var height = $(document).height();

        var fill = d3.scale.category20();

        var word_entries = d3.entries(word_count);

        var xScale = d3.scale.linear()
           .domain([0, d3.max(word_entries, function(d) {
              return d.value;
            })
           ])
           .range([10,100]);

        d3.layout.cloud().size([width, height])
          .timeInterval(20)
          .words(word_entries)
          .fontSize(function(d) { return xScale(+d.value); })
          .text(function(d) { return d.key; })
          .rotate(function() { return ~~(Math.random() * 2) * 90; })
          .font("Impact")
          .on("end", draw)
          .start();

        //d3.select("#concepts-div").remove();

        function draw(words) {

          d3.select("#concepts-div").append("svg")
              .attr("width", width)
              .attr("height", height)
            .append("g")
              .attr("transform", "translate(" + [width >> 1, height >> 1] + ")")
            .selectAll("text")
              .data(words)
            .enter().append("text")
              .style("font-size", function(d) { return xScale(d.value) + "px"; })
              .style("font-family", "Impact")
              .style("fill", function(d, i) { return fill(i); })
              .attr("text-anchor", "middle")
              .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .text(function(d) { return d.key; });
        }

        d3.layout.cloud().stop();
      }

function isElementInViewport (el) {

    //special bonus for those using jQuery
    if (typeof jQuery === "function" && el instanceof jQuery) {
        el = el[0];
    }

    var rect = el.getBoundingClientRect();

    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /*or $(window).height() */
        rect.right <= (window.innerWidth || document.documentElement.clientWidth) /*or $(window).width() */
    );
}



    // Set up Django CSRF Token Protection
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

function visSectionClick(d){
    //d3.select("#toc-section-"+d.id).on("click")();
    //tocSectionClick(d);
    console.log(d.epage-d.spage);
}

function initToc(course_structure){
    var vis_element = d3.select('#g_progress_vis').node();
    //var margin_left = vis_element.getBoundingClientRect().width;
    var margin = {top: 10, right: 0, bottom: 5, left: 20};

    var i = 0;

    var tree = d3.layout.tree()
        .nodeSize([0, 10]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });
    var width = $("#toc-div").width() - margin.left;
    var svg = d3.select("#toc-div").append("svg")
        .attr("id","svg-toc")
        .attr("width", width)// + margin.left + margin.right)
        .append("g")
            .attr("id","g_index")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    course_structure.x0 = 0;
    course_structure.y0 = 0;
    update(root = course_structure);

    function update(source) {

      // Compute the flattened node list. TODO use d3.layout.hierarchy.
      var nodes = tree.nodes(root);
      var margin = {top: 10, right: 0, bottom: 5, left: 10};

      var duration = 400;
      //var width = 400 - margin.left - margin.right,
      var  barHeight = 20,
        barWidth = width * .8;

      var height = Math.max(window.innerHeight, nodes.length * barHeight + margin.top + margin.bottom);


      d3.select("#svg-toc").transition()
          .duration(duration)
          .attr("height", height);

      d3.select(self.frameElement).transition()
          .duration(duration)
          .style("height", height + "px");

      // Compute the "layout".
      nodes.forEach(function(n, i) {
        n.x = i * barHeight;
      });

      // Update the nodes…
      var node = svg.selectAll("g.toc-section")
          .data(nodes, function(d) { return d.id || (d.id = ++i); });

      var nodeEnter = node.enter().append("g")
          .attr("class", "toc-section")
          .attr("id",function(d){return "toc-section-"+d.id;})
          .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
          .style("opacity", 1e-6)
          .on("click", tocSectionClick);

      // Enter any new nodes at the parent's previous-btn position
      nodeEnter.filter(function(d) {
                return d.children;
            })
        .append('path')
        .attr("class","toc-toggle active")
        .attr("d", d3.svg.symbol().type("triangle-down").size(70))
        .attr("transform", function(d) { return "translate(" + -6 + "," + 0+ ")"; })
        .style("fill", "#EB7900")
        .on("click", tocSectionToggle);

      nodeEnter.append("rect")
          .attr("y", -barHeight / 2)
          .attr("height", barHeight)
          .attr("width", function(d){ return d3.select("#svg-toc").attr("width");})
          .style("fill", "white");

      nodeEnter.append("text")
          .attr("dy", 5)
          .attr("dx", 10)
          .text(function(d) { return d.name; });

      // Transition nodes to their new position.
      nodeEnter.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
          .style("opacity", 1);

      node.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
          .style("opacity", 1)
        .select("rect")
          .style("fill", "white");

      // Transition exiting nodes to the parent's new position.
      node.exit().transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
          .style("opacity", 1e-6)
          .remove();

      /*
      // Update the links…
      var link = svg.selectAll("path.link")
          .data(tree.links(nodes), function(d) { return d.target.id; });

      // Enter any new links at the parent's previous-btn position.
      link.enter().insert("path", "g")
          .attr("class", "link")
          .attr("d", function(d) {
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
          })
        .transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition links to their new position.
      link.transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
      link.exit().transition()
          .duration(duration)
          .attr("d", function(d) {
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
          })
          .remove();*/

      // Stash the old positions for transition.
      nodes.forEach(function(d) {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    // Toggle children on click.
    function tocSectionToggle(d) {

        d3.event.stopPropagation();

        if(d3.select(this).classed("active")){
            d3.select(this)
                .classed("active",false)
                .transition()
                .duration(500)
                .attr("transform","translate(-5,0) rotate(-90)");
        }else{
            d3.select(this)
                .classed("active",true)
                .transition()
                .duration(500)
                .attr("transform","translate(-5,0) rotate(0)");
        }
        if (d.children) {
            d._children = d.children;
            d.children = null;
            } else {
            d.children = d._children;
            d._children = null;
        }

        update(d);
    }

    function tocSectionClick(d){
        //d3.selectAll(".toc-section.active").attr("class","toc-section");
        //d3.select(this).attr("class","toc-section active");
        var section_metadata = d;
        var section_id = section_metadata["id"];
        var resource_id = section_metadata["resourceid"];
        var page_num = section_metadata["spage"];
        var section_name = section_metadata["name"];
        loadResource(section_id,section_name,resource_id,page_num);
    }

}

    function loadPreviousPage(){
        var epage = parseInt(last_page_read["epage"]);
        var spage = parseInt(last_page_read["spage"]);
        var page = parseInt(last_page_read["page"]);
        var resourceid = last_page_read["resourceid"];
        console.log("epage: "+epage+" spage: "+spage+" page: "+page+" resourceid: "+resourceid);
        if (page > spage){
            last_page_read["page"] = page - 1;
            loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"]);
        }else{
            var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
            if(index_last_page_read >=0 && index_last_page_read < course_linear_structure.length){
                last_page_read = course_linear_structure[index_last_page_read-1];
                if(last_page_read["epage"]==page && resourceid==last_page_read["resourceid"]){
                    if(parseInt(last_page_read["epage"])-parseInt(last_page_read["spage"])==0) {
                        last_page_read = course_linear_structure[index_last_page_read-2];
                        last_page_read["page"] = last_page_read["epage"];
                    }else{
                        last_page_read["page"] = parseInt(last_page_read["epage"])-1;
                    }
                }else{
                    last_page_read["page"] = last_page_read["epage"];
                }
                loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"]);
            }
        }
    }

    function loadNextPage(){
        var epage = parseInt(last_page_read["epage"]);
        var spage = parseInt(last_page_read["spage"]);
        var page = parseInt(last_page_read["page"]);
        var resourceid = last_page_read["resourceid"];
        console.log("epage: "+epage+" spage: "+spage+" page: "+page+" resourceid: "+resourceid);
        if (page < epage){
            last_page_read["page"] = page + 1;
            loadResource(last_page_read["id"], last_page_read["name"], last_page_read["resourceid"], last_page_read["page"]);
        }else{
            var index_last_page_read = course_linear_structure.map(function(d) { return d.id; }).indexOf(last_page_read["id"]);
            if(index_last_page_read >=0 && index_last_page_read < course_linear_structure.length){
                last_page_read = course_linear_structure[index_last_page_read+1];
                if(last_page_read["spage"]==page && resourceid==last_page_read["resourceid"]){
                    if(parseInt(last_page_read["epage"])-parseInt(last_page_read["spage"])==0){
                        last_page_read = course_linear_structure[index_last_page_read+2];
                        last_page_read["page"] = last_page_read["spage"];
                    }else{
                        last_page_read["page"] = parseInt(last_page_read["spage"])+1;
                    }
                }else{
                    last_page_read["page"] = last_page_read["spage"];
                }
                loadResource(last_page_read["id"],last_page_read["name"],last_page_read["resourceid"],last_page_read["page"]);
            }
        }
    }

    function visSectionMouseover(d, i) {
        //d3.select(this).style("opacity", 1.0);

        //d3.select(this).style("stroke","#000");
        //d3.select(this).style("stroke-width", "1");

        // Then highlight only those that are an ancestor of the current segment.
        var sequenceArray = getAncestors(d);

        var highlighted_sections = d3.selectAll("rect")
            .filter(function(node) {
                return (sequenceArray.indexOf(node) >= 0);
            })
            .style("opacity", 1)
            .style("stroke", "black")
            .style("stroke-width","1")
            .style("filter", "url(#glow)");
        //highlighted_sections.moveToFront();



        /*if(d.type == "lecture"){
            //$("#tip").html(d.name + ":<br/>" + d.title); // @@@@
            $("#tip").html(d.title);
        }else{
            var bookName = getBookName(d.bookid);
            $("#tip").html("[Book] <b>" + bookName + "</b>: " + d.name);
        }*/
        $("#tip").css("color","#777777");

        /* BEGIN iframe selection */
        // @@@@ this was intended to show selection in the small multiples frame, but it is broken, and commented
        // @@@@ in order to prevent a javascript error
        if (d.type == "lecture") {
            //parent.frames['iframe-sm'].selectFunction('arc' + (d.name.replace(/ /g, "-")), 0.1);
        } else {
            //parent.frames['iframe-sm'].selectFunction('arc' + (searchParent(d).replace(/ /g, "-")), 0.1);
        }
        /* END iframe selection */
        //$("#tip").html("[Book] <b>" + bookName + "</b>: " + d.name);
        return false;
    }

    function openQuizWindow(){
        modal.style.display = "block";
        $("#left-div").addClass("blurred");
        $("#page-container").addClass("blurred");

        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_id = last_page_read["resourceid"];
        var page_num = last_page_read["page"];

        $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"quiz-load",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": []}) );
    }

    function closeQuizWindow(){
        modal.style.display = "none";
        $("#left-div").removeClass("blurred");
        $("#page-container").removeClass("blurred");
    }

    function loadQuiz(){
        /*var section_quizzes = ["ir-4-1-1-1","ir-4-1-1-3","4-1-2-3","4-1-4"];
        if(section_quizzes.includes(last_page_read["id"])){
            alert("there is a quiz");
        }*/
        //$.get( "http://{{ request.META.HTTP_HOST }}/reader_project/api/quiz",
        $.get( "http://{{ request.META.HTTP_HOST }}/api/quiz",
             {"user": {{ request.user.id }},
             "group": "{{ group }}",
             "section": last_page_read["id"]},
            function(data){
                quiz_data = data;
                $(".quiz-title").text(data["name"]);
                var questions = data["questions"];
                var question_ids = Object.keys(questions);

                if(question_ids.length>0){
                    //Insert questions in the quiz
                    $(".modal-body").empty();
                    var question_number = 0;
                    for(var i=0;i<question_ids.length;i++) {
                        var statement = questions[question_ids[i]]["statement"];
                        var type = questions[question_ids[i]]["type"];
                        console.log(type);
                        question_number = question_number + 1;
                        if(type=="multiple-choice-one-answer");
                            var question_id = question_ids[i];
                            $(".modal-body").append("<img class='no-feedback-img' id='q"+question_id+"-feedback-img'>");
                            $(".modal-body").append("<p class 'question-statement' id='q"+question_id+"-statement'>" + question_number + ".   " + statement + "</p>");
                            $(".modal-body").append("<ul id='q" + question_id + "'></ul>");
                            var choices = questions[question_id]["choices"];
                            for (var j = 0; j < choices.length; j++) {
                                var choice_id = choices[j]["id"]
                                var choice_statement = choices[j]["statement"];
                                $("#q" + question_ids[i]).append("<input class='multiple-choice-one-answer' type='radio' name='q" + question_id + "' value=" + choice_id + ">" + choice_statement + "<br>");
                            }
                            $(".modal-body").append("</br>");
                        if(type=="textual"){
                            $(".modal-body").append("<p>"+question_number+".   "+statement+"</p>");
                            $(".modal-body").append("<textarea class='textual' id='q"+question_ids[i]+"' rows='3'></textarea>");
                        }
                    }
                    //Enable quiz button
                    /*$(".next-btn").prop('disabled', true);
                    $(".quiz-btn").prop('disabled', false);*/
                }else{
                    //No quiz to show
                    /*$(".next-btn").prop('disabled', false);
                    $(".quiz-btn").prop('disabled', true);*/
                }

            });
    }

    function showPreTest(data){
        var kcs = data["concepts"];
        var kcs_ids = Object.keys(kcs);
        for(var i=0;i<kcs_ids.length;i++){
            var kc_id = kcs_ids[i];
             $(".modal-body").append("<p>"+kcs[kc_id]+"</p><input type='range' min='1' max='7' value='3' class='slider' id='myRange'>");
        }
        $(".modal-body").empty();
    }

    function submitQuiz(){
        var quiz_completed = true;
        //section_quizzes[last_page_read["id"]]=true;
        $(".next-btn").prop("disabled",false);
        $(".quiz-btn").prop("disabled",true);
        //closeQuizWindow();

        var section_id = last_page_read["id"];
        var section_name = last_page_read["name"];
        var resource_id = last_page_read["resourceid"];
        var page_num = last_page_read["page"];

        $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "session": "{{ request.session.session_key }}",
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"quiz-submit",
             //"datetime": new Date().toISOString(),
             "datetime": new Date().toIsoString(),
             "visible_text": []}) );

        var answers = [];
        //Check if all multiple choice questions are added
        var questions = quiz_data["questions"];
        var questions_ids = Object.keys(questions);
        for(var i=0;i<questions_ids.length;i++){
            question_id = questions_ids[i];
            question = questions[question_id];
            var type = question["type"];
            if(type=="multiple-choice-one-answer"){
                if (!$("input[name=q"+question_id+"]:checked").val()){
                    quiz_completed = false;
                }else{
                    var selected_choices = $("input[name=q"+question_id+"]:checked").val();
                    answers.push({"question_id":question_id, "type": type, "answer": selected_choices});
                }
            }
            if(type=="textual"){
                if ($('#q'+question_id).val() == ''){
                    quiz_completed = false;
                }else{
                    answers.push({"question_id":question_id, "type": type, "answer": $('#q'+question_id).val()});
                }
            }

        }
        if(quiz_completed){
            console.log(answers);
            var quiz_id= quiz_data["quiz"];
            //$.get( "http://{{ request.META.HTTP_HOST }}/reader_project/api/quiz/assess",
            $.ajax({
               url: "http://{{ request.META.HTTP_HOST }}/api/quiz/assess",
               data:
                   JSON.stringify({"quiz": quiz_id,
                   "user": {{request.user.id}},
                   "answers": answers
                   }),
               error: function() {
                  alert('We could not process your submission, please try it again');
               },
               success: function(data) {
                  var assessment = data["assessment"];
                  for (var i=0; i<assessment.length; i++){
                      var answer = assessment[i];
                      var type = answer["type"];
                      var question_id = answer["question_id"];

                      if(type=="multiple-choice-one-answer"){
                          var correct = answer["correct"];
                          $("#q"+question_id+"-feedback-img").removeClass();
                          if(correct==true){
                              $("#q"+question_id+"-feedback-img").addClass("correct-feedback-img");
                          }else{
                              $("#q"+question_id+"-feedback-img").addClass("incorrect-feedback-img");
                          }

                      }
                  }
               },
               type: 'POST',
               contentType: 'application/json',
               dataType: 'json'
            });

            //$(".submit-btn").text("Go back to read ❯");

            /*$(".submit-btn").unbind("click");
            $(".submit-btn").click(function(e){
                e.preventDefault();
                modal.style.display = "none";
                //$(".quiz-btn").removeClass("quiz-btn").addClass("next-btn");
                //$(".next-btn").text("Next ❯");
                return false;
            });
            loadNextPage();*/
        }else{
            alert("Need to complete all your answers!");
        }
    }

    function visSectionMouseout(d, i) {
        d3.selectAll("rect").style("stroke","white");
    }

    function highlightTocSection(section_id){
        d3.selectAll("g.toc-section.active").attr("class","toc-section").select("rect").style("fill","#ffffff");
        var toc_path_to_highlight = getAncestors(d3.select("#toc-section-"+section_id).node().__data__);
        for(var i=0;i<toc_path_to_highlight.length;i++){
            var section = toc_path_to_highlight[i]["id"];
            d3.select("g#toc-section-"+section)
                .attr("class","toc-section active")
                .select("rect")
                    .style("fill",function(d){return toc_color(d.depth)});
        }

    }

    function getAncestors(node) {
      var path = [];
      var current = node;
      while (current.parent) {
        path.unshift(current);
        current = current.parent;
      }
      return path;
    }

    function getSectionById(section_id){
        //TODO: check if section exists first or not
        var section = $.grep(course_linear_structure, function(d){ return d.id == section_id;})[0];
        return section;
    }

    function hierarchicalCourseSectionUpdate(sections, section_id, page) {
        for (section_index in sections){
            var section = sections[section_index];
            console.log("searching section: "+section_id);
            console.log(section["id"]);
            if (section["id"] == section_id) {
                console.log("section found");
                updateReadPage(section, page);
                return true;
            }
            // Item not returned yet. Search its children by recursive call.
            if (section.children) {
                var subresult = hierarchicalCourseSectionUpdate(section.children, section_id, page);
                // If the item was found in the subchildren, return it.
                if (subresult){
                    console.log("section found");
                    updateReadPage(section, page);
                    return true;
                }

            }
        }
        return false;
    }

    function updateReadPage(section, page){
        if(section["read_pages_list"].indexOf(page)==-1){
            section["read_pages_list"].push(page);
            section["read_pages"]=section["read_pages"]+1;
            d3.select("#rect-"+section["id"]).transition()
                .duration(500)
                .attr("fill", function(d){
                    console.log("update section");
                    console.log(section);
                    var visited_pages = section["read_pages"];
                    var total_section_pages = d.num_pages;
                    var proportion_visited_pages = visited_pages / total_section_pages;
                    return color(proportion_visited_pages)});
            if(section["parent"]){
                updateReadPage(section["parent"],page);
            }
        }
    }

    function hierarchicalToLinearStructure(data){

        if (data.children){
            var current_subsection = Object.assign({}, data);
            delete current_subsection['children'];
            if(current_subsection.epage !==undefined && current_subsection.spage!==undefined && current_subsection.resourceid!==undefined) {
                course_linear_structure.push(current_subsection);
            }
            data.children.forEach(function(d,i){
                    hierarchicalToLinearStructure(d);
                });
        }else{
            course_linear_structure.push(data);
        }

    }

    // https://github.com/wbkd/d3-extended
    d3.selection.prototype.moveToFront = function() {
      return this.each(function(){
        this.parentNode.appendChild(this);
      });
    };


    d3.selection.prototype.moveToBack = function() {
        return this.each(function() {
            var firstChild = this.parentNode.firstChild;
            if (firstChild) {
                this.parentNode.insertBefore(this, firstChild);
            }
        });
    };

    Date.prototype.toIsoString = function() {
        var tzo = -this.getTimezoneOffset(),
            dif = tzo >= 0 ? '+' : '-',
            pad = function(num) {
                var norm = Math.floor(Math.abs(num));
                return (norm < 10 ? '0' : '') + norm;
            };
        return this.getFullYear() +
            '-' + pad(this.getMonth() + 1) +
            '-' + pad(this.getDate()) +
            'T' + pad(this.getHours()) +
            ':' + pad(this.getMinutes()) +
            ':' + pad(this.getSeconds()) +
            dif + pad(tzo / 60) +
            ':' + pad(tzo % 60);
    }

</script>
</body>
</html>