{% load static %}
<html>
<head>
    <link rel="stylesheet" type="text/css" href="{% static "annotorious-0.6.4/css/annotorious.css" %}" />
    <link rel="stylesheet" type="text/css" href="http://assets.annotateit.org/annotator/v1.2.7/annotator.min.css" />
    <link rel="stylesheet" type="text/css" href="{% static "css/reader.css" %}" />

    <!--<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>-->

    <script type="text/javascript" src="{% static "annotorious-0.6.4/annotorious.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/within-viewport/withinviewport.js" %}"></script>


    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://assets.annotateit.org/annotator/v1.2.7/annotator-full.min.js"></script>
    <!--<script type="text/javascript" src="{% static 'js/annotator.min.js' %}"></script>-->

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script src="//d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="{% static "js/cloud.js" %}"></script>
    <script type="text/javascript" src="{% static "js/fisheye.js" %}"></script>

    <!--<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">-->

</head>
<body>
<div id="left-div">
    <div id="vis-div">
    </div>
    <div id="toc-div">
    </div>
</div>
<div id="reader-div">
   <div id="reader-controls">
      <ul class="pager">
        <li class="previous"><a href="#">Previous</a></li>
        <li><span class="title-current-section">Title</span></li>
        <li class="next"><a href="#">Next</a></li>
      </ul>
    </div>
    <div id="reader-canvas">
    </div>
</div>
<!--<div id="support-div">
    <div id="recommendations-div"></div>
    <div id="concepts-div"></div>
</div>-->

<div id="quiz-div" class="w3-modal">
    <div class="w3-modal-content">
      <div class="w3-container">
        <!--<span onclick="document.getElementById('id01').style.display='none'" class="w3-button w3-display-topright">&times;</span>
        <p>You will be presented with 5 questions</p>
          <p>How many of them you would think you will answer correctly?</p><br>
          <input type="text" name="prediction"><br>
          <input type="submit" data-inline="true" value="Submit">-->
          <form method="post" action="/action_page_post.php">
      <div data-role="rangeslider">
        <label for="price-min">Price:</label>
        <input type="range" name="price-min" id="price-min" value="200" min="0" max="1000">
      </div>
        <input type="submit" data-inline="true" value="Submit">
        <p>The range slider can be useful for allowing users to select a specific price range when browsing products.</p>
      </form>
      </div>
    </div>
</div>

<script type="text/javascript">
    var last_page_read = {};
    var resource_id;
    var course_hierarchical_structure = {};
    var course_linear_structure = [];


    jQuery(function ($) {
        var t = '';

        var csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        loadHtml();
        //$("#page-container").annotator();
        //$('#page-container').annotator()
                            //.annotator('addPlugin', 'Tags');

        $('.previous').click( function(e) {
            e.preventDefault();
            loadPreviousPage();
            return false;
        });

        $('.next').click( function(e) {
            e.preventDefault();
            loadNextPage();
            return false;
        });

        function gText(e) {
            t = window.getSelection().toString();
            console.log(t);
            $.ajax({
                    url: 'http://en.wikipedia.org/w/api.php',
                    data: { action: 'query', list: 'search', srsearch: t, format: 'json' },
                    dataType: 'jsonp',
                    success: processResult
                });
        }

        function processResult(apiResult){
         for (var i = 0; i < apiResult.query.search.length; i++){
              $('#recommendations-div').append('<p>'+apiResult.query.search[i].title+'</p>');
         }
      }

        //document.onmouseup = gText;
    });

// extension:
$.fn.scrollEnd = function(callback, timeout) {
  $(this).scroll(function(){
    var $this = $(this);
    if ($this.data('scrollTimeout')) {
      clearTimeout($this.data('scrollTimeout'));
    }
    $this.data('scrollTimeout', setTimeout(callback,timeout));
  });
};


function loadHtml() {
    {% autoescape off %}
    course_hierarchical_structure = {{course_hierarchical}};
    //course_linear_structure = {{course_linear}};
    console.log(course_hierarchical_structure);
    hierarchicalToLinearStructure(course_hierarchical_structure);
    last_page_read = {{last_page_read}};
    {% endautoescape %}
    console.log(course_linear_structure);
    //If the user has not read any page from the course, the first page needs to be shown
    if(jQuery.isEmptyObject(last_page_read)){
        last_page_read = course_linear_structure[0];
        last_page_read["page"]=last_page_read["spage"];
    }else{
        var last_section_read = $.grep(course_linear_structure, function(d){ return d.section == last_page_read["section"]; });
        last_section_read[0].page=last_page_read["page"];
        last_page_read = last_section_read[0];
    }
    console.log(last_page_read);
    initProgressVis(course_hierarchical_structure);
    initToc(course_hierarchical_structure);
    loadResource(last_page_read["section"],"test",last_page_read["resource"],last_page_read["page"]);

    var text_html = $('.t').text();
    console.log($(".t")[0]);
    //initWordCloud(text_html);

    var content = $('#page-container').annotator();
    content.annotator('addPlugin', 'Store', {
      // The endpoint of the store on your server.
      prefix: '/annotator',

      // Attach the uri of the current page to all annotations to allow search.
      annotationData: {
        'uri': window.location.href
      },

      // This will perform a "search" action when the plugin loads. Will
      // request the last 20 annotations for the current url.
      // eg. /store/endpoint/search?limit=20&uri=http://this/document/only
      loadFromSearch: {
        //'limit': 20,
        'uri': window.location.href
      },
      urls: {
        // These are the default URLs.
        create:  '/annotations',
        update:  '/annotations/:id',
        destroy: '/annotations/:id',
        search:  '/search'
      }
    });
    //});

}

function loadResource(section_id,section_name,resource_id,page_num){
     var resource_path = "resources/"+resource_id+"/"+resource_id+"-"+page_num+".html";
     console.log(resource_path);
     $("#reader-canvas").load("{% static "/" %}"+resource_path,function() {

         //Set section title at the top of the reader
        $(".title-current-section").html(section_name);
        var text_html = $('.t').text();
        console.log(text_html);
        //initWordCloud(text_html);

        /*var content = $('#page-container').annotator();
        content.annotator('addPlugin', 'Store', {
          // The endpoint of the store on your server.
          prefix: '/annotator',

          // Attach the uri of the current page to all annotations to allow search.
          annotationData: {
            'uri': window.location.href
          },

          // This will perform a "search" action when the plugin loads. Will
          // request the last 20 annotations for the current url.
          // eg. /store/endpoint/search?limit=20&uri=http://this/document/only
          loadFromSearch: {
            //'limit': 20,
            'uri': window.location.href
          },
          urls: {
            // These are the default URLs.
            create:  '/annotations',
            update:  '/annotations/:id',
            destroy: '/annotations/:id',
            search:  '/search'
          }
        });*/
         console.log("{{ request.META.HTTP_HOST }} {{group}}");
         $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-load",
             "datetime": new Date().toISOString()}) );

         //If user scrolls the page
        $("#page-container").scrollEnd(function(){
            //Log scroll event by using the reader api

            //Get all the text html containers
            var visible_text_elements = [];
            var visible_text = "";
            $("#page-container").find(".t").each(function(){
                if(isElementInViewport($(this))){
                    visible_text_elements.push($(this).attr("class"));
                    visible_text = visible_text + " " + $(this).text();
                }
            });

            $.post( "http://{{ request.META.HTTP_HOST }}/api/reader", JSON.stringify(
             {"user": {{ request.user.id }},
             "group": "{{ group }}",
             "section": section_id,
             "name": section_name,
             "resource": resource_id,
             "page": page_num,
             "action":"page-scroll",
             "datetime": new Date().toISOString(),
             "visible_text": visible_text_elements}) );

            console.log(visible_text)
        }, 500);
    });
}

function initProgressVis(course_structure){
    var root = course_structure;

    var w = $("#vis-div").width()/2;
    var h = $("#vis-div").height();

    var svg_size = w-2;

    var partition = d3.layout.partition()
        .sort(null)
        .children(function children(d) {
          return d.children;
        })
        .value(function(d) {return Math.log(d.epage-d.spage+1); });

    var color = d3.scale.linear()
        .domain([0.0, 1.0])
        //.range(["#ECEEF5", "#011568"]);
        .range(["#E0E0E0", "#339933"]);

    var x = d3.scale.linear()
        .range([0, w]);
        //.range([0, h]);
    var y = d3.scale.linear()
            .range([0, h]);
            //range([0, w]);

    var x_comp = d3.scale.linear()
        .range([w, 0]);

    var separation = 1.5;
      var y_separation = 1;

    var fisheye = d3.fisheye.circular()
    .radius(100)
    .distortion(2);

    var svg_comp = d3.select("#vis-div").append("svg")
        .attr("id","svg-vis-comp")
        .attr("width", svg_size )
        .attr("height", h)
            .append("g")
            .attr("id","g_progress_vis_comp");

    var rect_comp = svg_comp.selectAll("rect");

    rect_comp = rect_comp
          .data(partition(root))
        .enter().append("g")
            .attr("class", function (d) {
                    classname = "partition_depth_" + d.depth;

                    //if (d.depth > 0){
                        classname += " partition_docno_" + d.docno;
                    //}

                    return classname;
                })
            .append("rect")
          .attr("x", function(d) {
                return x_comp(d.y)-d.depth*separation;
                //return d.depth*(separation+widthLayer);
            })
          .attr("y", function(d) { return y(d.x)+y_separation; })
          .attr("width", function(d) { return x(d.dy); })
          .attr("height", function(d) { return y(d.dx); })
          .attr("fill", function (d) {
                    //var visited_pages = d.num_visited_pages;
                    /*var total_section_pages = 0;
                    if(d.children){
                        if(d.epage && d.spage){
                            total_section_pages = d.epage - d.spage+1;
                        }
                        else{
                            total_section_pages = 1;
                        }
                    }else{
                        total_section_pages = d.epage - d.spage+1;

                    }
                    var proportion_visited_pages = visited_pages/total_section_pages;
                    console.log(proportion_visited_pages);
                    /*for (count = 0; count < diagram.length; count++) {
                        if (diagram[count].docNum == d.docno) {
                            return d3.rgb(diagram[count].diagramColor)
                        }
                    }*/
                    return color(d.group_read_proportion);
                })
          .attr("class", function (d) {
                    classname = "partition_depth_" + d.depth;

                    //if (d.depth > 0){
                        classname += " partition_docno_" + d.docno;
                    //}

                    return classname;
                })
          .attr("display", function(d) { return d.depth && d.depth<=4 ? null : "none"; })//d.depth && d.depth<=3 ? null : "none"; })
          .attr("stroke-width","1px")
          .attr("stroke","white")
          .attr("opacity",1)
          .on("mouseover",visSectionMouseover)
          .on("mouseout",visSectionMouseout);
          /*.on("click", visSectionClick)
          .on("dblclick", partitionTableDoubleClick)
          .on("mouseout",partitionTableMouseout);*/

    var svg = d3.select("#vis-div").append("svg")
        .attr("id","svg-vis")
        .attr("width", svg_size)
        .attr("height", h)
            .append("g")
            .attr("id","g_progress_vis");

     var rect = svg.selectAll("rect");

     rect = rect
          .data(partition(root))
        .enter().append("g")
            .attr("class", function (d) {
                    classname = "partition_depth_" + d.depth;

                    //if (d.depth > 0){
                        classname += " partition_docno_" + d.docno;
                    //}

                    return classname;
                })
            .append("rect")
          .attr("x", function(d) {
                return x(d.y)+d.depth*separation;
                //return d.depth*(separation+widthLayer);
            })
          .attr("y", function(d) { return y(d.x)+y_separation; })
          .attr("width", function(d) { return x(d.dy); })
          .attr("height", function(d) { return y(d.dx); })
          .attr("fill", function (d) {
                    var visited_pages = d.num_visited_pages;
                    var total_section_pages = d.num_pages;
                    /*if(d.children){
                        if(d.epage && d.spage){
                            total_section_pages = d.epage - d.spage+1;
                        }
                        else{
                            total_section_pages = 1;
                        }
                    }else{
                        total_section_pages = d.epage - d.spage+1;

                    }*/
                    var proportion_visited_pages = visited_pages/total_section_pages;
                    console.log(proportion_visited_pages);
                    /*for (count = 0; count < diagram.length; count++) {
                        if (diagram[count].docNum == d.docno) {
                            return d3.rgb(diagram[count].diagramColor)
                        }
                    }*/
                    return color(proportion_visited_pages);
                })
          .attr("class", function (d) {
                    classname = "partition_depth_" + d.depth;

                    //if (d.depth > 0){
                        classname += " partition_docno_" + d.docno;
                    //}

                    return classname;
                })
          .attr("display", function(d) { return d.depth && d.depth<=4 ? null : "none"; })//d.depth && d.depth<=3 ? null : "none"; })
          .attr("stroke-width","1px")
          .attr("stroke","white")
          .attr("opacity",1)
          .on("click", visSectionClick)
          .on("mouseover",visSectionMouseover)
          .on("mouseout",visSectionMouseout);
          /*.on("dblclick", partitionTableDoubleClick)
          .on("mouseover",partitionTableMouseover)
          .on("mouseout",partitionTableMouseout);*/

        //Container for the gradients
        var defs = svg.append("defs");

        //Filter for the outside glow
        var filter = defs.append("filter")
            .attr("id","glow");
        filter.append("feGaussianBlur")
            .attr("stdDeviation","4")
            .attr("result","coloredBlur");
        var feMerge = filter.append("feMerge");
        feMerge.append("feMergeNode")
            .attr("in","coloredBlur");
        feMerge.append("feMergeNode")
            .attr("in","SourceGraphic");

        /*svg.on("mousemove", function() {
            fisheye.focus(d3.mouse(this));
            rect.each(function(d) { d.fisheye = fisheye(d); })
                .attr("x",function(d){return d.fisheye.y;});
        });*/

        /*var subsections = svg.selectAll("g.partition_depth_2");

        subsections.append("circle")
            .attr("cx", function (d,i) {*/
                /*if (i%2){
                    return x(d.y)+x(d.dy)+40;
                }else{
                    return x(d.y)+40;
                }*/
                //return (x(d.y)+x(d.dy)/2+(separation*2)-1.5);
                /*return (x(d.y)+x(d.dy)/2+(separation*2)-1.5);
            })
            .attr("cy", function (d,i) { return y(d.x)+(y(d.dx)/2); })
            .attr("r", 2)
            .style("fill", "#c5c5c5")*/
            //.attr("stroke-width","0.5px")
            //.style("stroke", "black")
            /*.style("z-index","1000");*/

        /*subsections.append("text")
                .attr("dx", function(d){return x(d.y)+x(d.dy)/2+(separation*2)-3.5;})
                .attr("dy", function (d) { return y(d.x)+(y(d.dx)/2)+3;})
                .style("font-size","8px")
                .text("?");*/

        /*var subsections3 = svg.selectAll("g.partition_depth_3");


        subsections3.append("circle")
            .attr("cx", function (d,i) {*/
                /*if (i%2){
                    return x(d.y)+x(d.dy)+40;
                }else{
                    return x(d.y)+40;
                }*/
                //return x(d.y)+x(d.dy)/2+(separation*4)-1.5;
                /*return (Math.random()*30)+(1.7*x(d.y))+(separation*4)-1.5;
            })
            .attr("cy", function (d,i) { return y(d.x)+(y(d.dx)/2); })
            .attr("r", 2)
            .style("fill", "#c5c5c5")*/
            //.attr("stroke-width","0.5px")
            //.style("stroke", "black")
            /*.style("z-index","1000");*/
}
function initWordCloud(text_string){
        var common = "poop,i,me,my,myself,we,us,our,ours,ourselves,you,your,yours,yourself,yourselves,he,him,his,himself,she,her,hers,herself,it,its,itself,they,them,their,theirs,themselves,what,which,who,whom,whose,this,that,these,those,am,is,are,was,were,be,been,being,have,has,had,having,do,does,did,doing,will,would,should,can,could,ought,i'm,you're,he's,she's,it's,we're,they're,i've,you've,we've,they've,i'd,you'd,he'd,she'd,we'd,they'd,i'll,you'll,he'll,she'll,we'll,they'll,isn't,aren't,wasn't,weren't,hasn't,haven't,hadn't,doesn't,don't,didn't,won't,wouldn't,shan't,shouldn't,can't,cannot,couldn't,mustn't,let's,that's,who's,what's,here's,there's,when's,where's,why's,how's,a,an,the,and,but,if,or,because,as,until,while,of,at,by,for,with,about,against,between,into,through,during,before,after,above,below,to,from,up,upon,down,in,out,on,off,over,under,again,further,then,once,here,there,when,where,why,how,all,any,both,each,few,more,most,other,some,such,no,nor,not,only,own,same,so,than,too,very,say,says,said,shall";

        var word_count = {};
        console.log("init wordcloud");
        var words = text_string.split(/[ '\-\(\)\*":;\[\]|{},.!?]+/);
          if (words.length == 1){
            word_count[words[0]] = 1;
          } else {
            words.forEach(function(word){
              var word = word.toLowerCase();
              if (word != "" && common.indexOf(word)==-1 && word.length>1){
                if (word_count[word]){
                  word_count[word]++;
                } else {
                  word_count[word] = 1;
                }
              }
            })
          }

        var svg_location = "#concepts-div";
        var width = document.getElementById("concepts-div").clientWidth;//$(document).width();
        var height = document.getElementById("concepts-div").clientHeight;//$(document).width();
        //var height = $(document).height();

        var fill = d3.scale.category20();

        var word_entries = d3.entries(word_count);

        var xScale = d3.scale.linear()
           .domain([0, d3.max(word_entries, function(d) {
              return d.value;
            })
           ])
           .range([10,100]);

        d3.layout.cloud().size([width, height])
          .timeInterval(20)
          .words(word_entries)
          .fontSize(function(d) { return xScale(+d.value); })
          .text(function(d) { return d.key; })
          .rotate(function() { return ~~(Math.random() * 2) * 90; })
          .font("Impact")
          .on("end", draw)
          .start();

        //d3.select("#concepts-div").remove();

        function draw(words) {

          d3.select("#concepts-div").append("svg")
              .attr("width", width)
              .attr("height", height)
            .append("g")
              .attr("transform", "translate(" + [width >> 1, height >> 1] + ")")
            .selectAll("text")
              .data(words)
            .enter().append("text")
              .style("font-size", function(d) { return xScale(d.value) + "px"; })
              .style("font-family", "Impact")
              .style("fill", function(d, i) { return fill(i); })
              .attr("text-anchor", "middle")
              .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .text(function(d) { return d.key; });
        }

        d3.layout.cloud().stop();
      }

function isElementInViewport (el) {

    //special bonus for those using jQuery
    if (typeof jQuery === "function" && el instanceof jQuery) {
        el = el[0];
    }

    var rect = el.getBoundingClientRect();

    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /*or $(window).height() */
        rect.right <= (window.innerWidth || document.documentElement.clientWidth) /*or $(window).width() */
    );
}



    // Set up Django CSRF Token Protection
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

function visSectionClick(d){
    //d3.select("#toc-section-"+d.id).on("click")();
    //tocSectionClick(d);
    console.log(d.epage-d.spage);
}

function initToc(course_structure){
    var vis_element = d3.select('#g_progress_vis').node();
    //var margin_left = vis_element.getBoundingClientRect().width;
    var margin = {top: 10, right: 0, bottom: 5, left: 0};

    var i = 0;

    var tree = d3.layout.tree()
        .nodeSize([0, 10]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });
    var width = $("#toc-div").width();
    var svg = d3.select("#toc-div").append("svg")
        .attr("id","svg-toc")
        .attr("width", width)// + margin.left + margin.right)
        .append("g")
            .attr("id","g_index")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    course_structure.x0 = 0;
    course_structure.y0 = 0;
    update(root = course_structure);

    function update(source) {

      // Compute the flattened node list. TODO use d3.layout.hierarchy.
      var nodes = tree.nodes(root);
      var margin = {top: 10, right: 0, bottom: 5, left: 10};

      var duration = 400;
      //var width = 400 - margin.left - margin.right,
      var  barHeight = 20,
        barWidth = width * .8;

      var height = Math.max(window.innerHeight, nodes.length * barHeight + margin.top + margin.bottom);


      d3.select("#svg-toc").transition()
          .duration(duration)
          .attr("height", height);

      d3.select(self.frameElement).transition()
          .duration(duration)
          .style("height", height + "px");

      // Compute the "layout".
      nodes.forEach(function(n, i) {
        n.x = i * barHeight;
      });

      // Update the nodes…
      var node = svg.selectAll("g.toc-section")
          .data(nodes, function(d) { return d.id || (d.id = ++i); });

      var nodeEnter = node.enter().append("g")
          .attr("class", "toc-section")
          .attr("id",function(d){return "toc-section-"+d.id;})
          .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
          .style("opacity", 1e-6)
          .on("click", tocSectionClick);

      // Enter any new nodes at the parent's previous position
      nodeEnter.filter(function(d) {
                return d.depth<3;
            })
        .append('path')
        .attr("class","toc-toggle active")
        .attr("d", d3.svg.symbol().type("triangle-down").size(70))
        .attr("transform", function(d) { return "translate(" + -5 + "," + 0+ ")"; })
        .style("fill", "#EB9100")
        .on("click", tocSectionToggle);

      nodeEnter.append("rect")
          .attr("y", -barHeight / 2)
          .attr("height", barHeight)
          .attr("width", function(d){ return d3.select("#svg-toc").attr("width");})
          .style("fill", color);

      nodeEnter.append("text")
          .attr("dy", 5)
          .attr("dx", 10)
          .text(function(d) { return d.name; });

      // Transition nodes to their new position.
      nodeEnter.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
          .style("opacity", 1);

      node.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
          .style("opacity", 1)
        .select("rect")
          .style("fill", color);

      // Transition exiting nodes to the parent's new position.
      node.exit().transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
          .style("opacity", 1e-6)
          .remove();

      /*
      // Update the links…
      var link = svg.selectAll("path.link")
          .data(tree.links(nodes), function(d) { return d.target.id; });

      // Enter any new links at the parent's previous position.
      link.enter().insert("path", "g")
          .attr("class", "link")
          .attr("d", function(d) {
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
          })
        .transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition links to their new position.
      link.transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
      link.exit().transition()
          .duration(duration)
          .attr("d", function(d) {
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
          })
          .remove();*/

      // Stash the old positions for transition.
      nodes.forEach(function(d) {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    // Toggle children on click.
    function tocSectionToggle(d) {

        d3.event.stopPropagation();

        if(d3.select(this).classed("active")){
            d3.select(this)
                .classed("active",false)
                .transition()
                .duration(500)
                .attr("transform","translate(-5,0) rotate(-90)");
        }else{
            d3.select(this)
                .classed("active",true)
                .transition()
                .duration(500)
                .attr("transform","translate(-5,0) rotate(0)");
        }
        if (d.children) {
            d._children = d.children;
            d.children = null;
            } else {
            d.children = d._children;
            d._children = null;
        }

        update(d);
    }

    function tocSectionClick(d){
        d3.selectAll(".toc-section.active").attr("class","toc-section");
        d3.select(this).attr("class","toc-section active");
        var section_metadata = d;
        var section_id = section_metadata["id"];
        var resource_id = section_metadata["resourceid"];
        var page_num = section_metadata["spage"];
        var section_name = section_metadata["name"];
        console.log("prueba");
        loadResource(section_id,section_name,resource_id,page_num);
        console.log("test");
        var last_section_read = $.grep(course_linear_structure, function(d){ return d.section == section_id; });
        last_section_read[0].page=last_section_read["spage"];
        last_page_read = last_section_read[0];
        console.log(last_page_read);
    }

    function color(d) {
      return "#fff";//d._children ? "#3182bd" : d.children ? "#c6dbef" : "#fd8d3c";
    }
}

    function loadPreviousPage(){
        console.log(last_page_read);
        if (last_page_read["page"] > last_page_read["spage"]){
            last_page_read["page"] = last_page_read["page"] - 1;
            loadResource(last_page_read["section"],"test",last_page_read["resource"],last_page_read["page"]);
        }else{
            var index_last_page_read = course_linear_structure.map(function(d) { return d.section; }).indexOf(last_page_read["section"]);
            console.log(index_last_page_read);
            if(index_last_page_read >=0 && index_last_page_read < course_linear_structure.length){
                last_page_read = course_linear_structure[index_last_page_read-1];
                last_page_read["page"] = last_page_read["epage"];
                loadResource(last_page_read["section"],"test",last_page_read["resource"],last_page_read["page"]);
            }
        }
    }

    function loadNextPage(){
        console.log(last_page_read);
        if (last_page_read["page"] < last_page_read["epage"]){
            last_page_read["page"] = last_page_read["page"] + 1;
            loadResource(last_page_read["section"],"test",last_page_read["resource"],last_page_read["page"]);
            if(last_page_read["page"] == last_page_read["epage"]){
                console.log("last page");
                document.getElementById('quiz-div').style.display='block';
            }
        }else{
            var index_last_page_read = course_linear_structure.map(function(d) { return d.section; }).indexOf(last_page_read["section"]);
            console.log(index_last_page_read);
            if(index_last_page_read >=0 && index_last_page_read < course_linear_structure.length){
                last_page_read = course_linear_structure[index_last_page_read+1];
                last_page_read["page"] = last_page_read["spage"];
                loadResource(last_page_read["section"],"test",last_page_read["resource"],last_page_read["page"]);
            }
        }
    }

    function visSectionMouseover(d, i) {
        //d3.select(this).style("opacity", 1.0);

        //d3.select(this).style("stroke","#000");
        //d3.select(this).style("stroke-width", "1");

        // Then highlight only those that are an ancestor of the current segment.
        var sequenceArray = getAncestors(d);
        console.log("ancestors");
        console.log(sequenceArray);

        var highlighted_sections = d3.selectAll("rect")
            .filter(function(node) {
                return (sequenceArray.indexOf(node) >= 0);
            })
            .style("opacity", 1)
            .style("stroke", "black")
            .style("stroke-width","1")
            .style("filter", "url(#glow)");
        //highlighted_sections.moveToFront();



        /*if(d.type == "lecture"){
            //$("#tip").html(d.name + ":<br/>" + d.title); // @@@@
            $("#tip").html(d.title);
        }else{
            var bookName = getBookName(d.bookid);
            $("#tip").html("[Book] <b>" + bookName + "</b>: " + d.name);
        }*/
        $("#tip").css("color","#777777");

        /* BEGIN iframe selection */
        // @@@@ this was intended to show selection in the small multiples frame, but it is broken, and commented
        // @@@@ in order to prevent a javascript error
        if (d.type == "lecture") {
            //parent.frames['iframe-sm'].selectFunction('arc' + (d.name.replace(/ /g, "-")), 0.1);
        } else {
            //parent.frames['iframe-sm'].selectFunction('arc' + (searchParent(d).replace(/ /g, "-")), 0.1);
        }
        /* END iframe selection */
        //$("#tip").html("[Book] <b>" + bookName + "</b>: " + d.name);
        return false;
    }

    function visSectionMouseout(d, i) {

        d3.selectAll("rect").style("stroke","white");

    }

    function getAncestors(node) {
      var path = [];
      var current = node;
      while (current.parent) {
        path.unshift(current);
        current = current.parent;
      }
      return path;
    }

    function hierarchicalToLinearStructure(data){
        if (data.children){
            var current_subsection = Object.assign({}, data);
            delete current_subsection['children'];
            course_linear_structure.push(current_subsection);
            for(subsection in data.children) {
                data.children.forEach(function(d,i){
                    hierarchicalToLinearStructure(d);
                });
            }
        }else{
            course_linear_structure.push(data);
        }
    }

    // https://github.com/wbkd/d3-extended
    d3.selection.prototype.moveToFront = function() {
      return this.each(function(){
        this.parentNode.appendChild(this);
      });
    };

    d3.selection.prototype.moveToBack = function() {
        return this.each(function() {
            var firstChild = this.parentNode.firstChild;
            if (firstChild) {
                this.parentNode.insertBefore(this, firstChild);
            }
        });
    };

</script>
</body>
</html>